name: üîç Debug Nginx Specific Issues

on:
  workflow_dispatch:  # Manual trigger only

env:
  VPS_HOST: 104.168.159.24
  VPS_PORT: 57411
  VPS_USER: deploy
  DEPLOY_PATH: /opt/lanet-helpdesk

jobs:
  debug-nginx:
    name: üîç Nginx Specific Diagnostics
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ env.VPS_PORT }} ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: üîç Nginx Specific Diagnostics
        run: |
          ssh -i ~/.ssh/id_ed25519 -p ${{ env.VPS_PORT }} ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            set -e
            
            echo "üîç NGINX SPECIFIC DIAGNOSTICS"
            echo "================================================"
            
            echo "üìã Nginx Container Status:"
            docker ps -a | grep nginx || echo "No nginx container found"
            
            echo ""
            echo "üìã Nginx Container Logs (last 50 lines):"
            docker logs --tail=50 lanet-helpdesk-nginx 2>&1 || echo "Cannot get nginx logs"
            
            echo ""
            echo "üìã Nginx Configuration Test:"
            docker exec lanet-helpdesk-nginx nginx -t 2>&1 || echo "Cannot test nginx config - container not running"
            
            echo ""
            echo "üìã Nginx Configuration File:"
            docker exec lanet-helpdesk-nginx cat /etc/nginx/conf.d/default.conf 2>&1 || echo "Cannot read nginx config - container not running"
            
            echo ""
            echo "üìã Frontend Container Network Info:"
            docker inspect lanet-helpdesk-frontend | grep -A 10 "NetworkSettings" || echo "Cannot inspect frontend container"
            
            echo ""
            echo "üìã Network Connectivity Test from Nginx to Frontend:"
            docker exec lanet-helpdesk-nginx ping -c 2 lanet-helpdesk-frontend 2>&1 || echo "Cannot ping from nginx to frontend"
            
            echo ""
            echo "üìã Docker Network Info:"
            docker network ls
            docker network inspect lanet-network 2>&1 || echo "Cannot inspect lanet-network"
            
            echo ""
            echo "üìã Host nginx.conf File:"
            cat /opt/lanet-helpdesk/nginx/nginx.conf 2>&1 || echo "Cannot read host nginx.conf"
            
            echo ""
            echo "üìã Docker Compose Nginx Service:"
            cd /opt/lanet-helpdesk
            docker-compose config | grep -A 20 "nginx:" || echo "Cannot get nginx service config"
            
            echo "================================================"
            echo "‚úÖ Nginx diagnostics completed!"
          EOF
