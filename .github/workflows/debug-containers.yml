name: 🔍 Debug Container Status

on:
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: lanet-helpdesk-containers-rg
  CONTAINER_GROUP_NAME: lanet-helpdesk

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
    - name: 🔐 Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 🔍 Check Container Status
      run: |
        echo "🔍 Checking container group status..."
        az container show --resource-group $AZURE_RESOURCE_GROUP --name $CONTAINER_GROUP_NAME --query "properties.instanceView.state" --output tsv
        
        echo ""
        echo "📊 Container details:"
        az container show --resource-group $AZURE_RESOURCE_GROUP --name $CONTAINER_GROUP_NAME --query "properties.containers[].{Name:name,State:properties.instanceView.currentState.state,RestartCount:properties.instanceView.restartCount}" --output table
        
        echo ""
        echo "🌐 Network info:"
        az container show --resource-group $AZURE_RESOURCE_GROUP --name $CONTAINER_GROUP_NAME --query "properties.ipAddress" --output json
        
        echo ""
        echo "📋 Recent events:"
        az container show --resource-group $AZURE_RESOURCE_GROUP --name $CONTAINER_GROUP_NAME --query "properties.containers[].properties.instanceView.events[-3:]" --output json

    - name: 🧪 Simple Connectivity Test
      run: |
        echo "🧪 Testing connectivity..."
        CONTAINER_IP=$(az container show --resource-group $AZURE_RESOURCE_GROUP --name $CONTAINER_GROUP_NAME --query ipAddress.ip --output tsv)
        echo "Container IP: $CONTAINER_IP"

        echo "Testing HTTP response:"
        curl -I --connect-timeout 10 http://$CONTAINER_IP/ || echo "HTTP request failed"
